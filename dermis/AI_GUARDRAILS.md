# AI Clinical Documentation Guardrails

## Overview
This system implements strict safety guardrails for all AI-generated clinical content in the Dermis EMR. These guardrails ensure AI outputs never make definitive diagnostic claims without provider oversight and comply with medical-legal requirements.

## Key Components

### 1. Guardrails Module (`src/lib/ai/guardrails.ts`)
Central validation system with the following functions:

#### Input Validation
- `validateClinicalInput()` - Validates provider input before AI generation
  - Requires minimum 10 characters of clinical detail
  - Requires chief complaint
  - Flags requests for diagnosis without examination findings
  - Warns about vague language

#### Output Validation
- `validateClinicalOutput()` - Sanitizes AI-generated notes
  - Replaces absolute diagnostic language with hedged terms
  - Detects potential fabricated information
  - Ensures hedging language in assessments
  - Flags medication dosages for verification

#### Code Validation
- `validateCodeSuggestions()` - Validates ICD-10/CPT suggestions
  - Ensures codes are appropriately caveated
  - Flags overly specific codes without sufficient documentation
  - Adds verification requirements

#### Lesion Analysis
- `sanitizeLesionAnalysis()` - Removes diagnostic claims from lesion descriptions
  - Replaces "this is melanoma" with "features that warrant further evaluation"
  - Ensures disclaimer about clinical correlation
  - Uses only descriptive language

#### Comprehensive Pipeline
- `validateClinicalNoteGeneration()` - Full validation pipeline
  - Validates input
  - Validates output
  - Validates code suggestions
  - Adds disclaimers and markers
  - Returns sanitized, safe output

### 2. Updated Clinical Notes System (`src/lib/ai/clinical-notes.ts`)

#### Strict System Prompt
New system prompt includes 8 critical safety rules:
1. NEVER DIAGNOSE - use "consistent with", "suggestive of"
2. NEVER RECOMMEND SPECIFIC TREATMENTS - use "provider may consider"
3. NEVER FABRICATE INFORMATION
4. NEVER ADD INFORMATION NOT PROVIDED
5. ALWAYS USE HEDGING LANGUAGE
6. ALWAYS FLAG INCOMPLETE INFORMATION
7. ASSESSMENT SECTION RULES - differential considerations only
8. PLAN SECTION RULES - mark AI suggestions clearly

#### AI Disclaimer
Every generated note includes:
```
‚ö†Ô∏è AI-ASSISTED DOCUMENTATION - REQUIRES PROVIDER REVIEW AND APPROVAL

This content was generated by AI to assist with documentation. The provider must:
- Review all information for accuracy
- Verify all diagnoses and treatment recommendations
- Confirm appropriate coding before submission
- Add or modify any information as clinically indicated
```

#### Validation Flow
1. **Before Generation**: Input validation rejects insufficient detail
2. **After Generation**: Output validation sanitizes language
3. **Before Display**: Disclaimers and markers added

### 3. Safety Replacements

Automatic language replacements include:

| ‚ùå Avoid | ‚úì Use Instead |
|---------|---------------|
| "patient has" | "findings consistent with" |
| "diagnosis is" | "differential includes" |
| "this is" | "appearance suggestive of" |
| "clearly shows" | "appears to show" |
| "recommend starting" | "provider may consider" |
| "patient will take" | "provider may prescribe" |

### 4. Markers in Output

- `[PROVIDER TO COMPLETE]` - Missing information that provider must add
- `[PROVIDER TO VERIFY]` - AI suggestion requiring provider confirmation
- `[SUGGESTED - PROVIDER TO VERIFY]` - Treatment recommendations
- `[VERIFY BEFORE SUBMISSION]` - Code suggestions
- `[INCOMPLETE - PROVIDER TO REVIEW]` - Sections with insufficient detail

## Usage Examples

### Example 1: Input Validation
```typescript
// ‚ùå This will be rejected:
quickInput: "rash"
// Error: "Provider input is too brief. Please provide at least 10 characters..."

// ‚úì This will be accepted:
quickInput: "Patient has erythematous macular rash on trunk, no scale, no itch"
chiefComplaint: "New rash"
```

### Example 2: Output Sanitization
```typescript
// AI output before guardrails:
"Patient has actinic keratosis. Start 5-FU cream."

// After guardrails:
"Findings consistent with actinic keratosis. [SUGGESTED - PROVIDER TO VERIFY] Consider 5-FU cream per provider discretion."
```

### Example 3: Lesion Analysis
```typescript
// Before guardrails:
"This appears to be a melanoma based on irregular borders and color variation."

// After guardrails:
"Pigmented lesion with irregular borders and color variation shows features that warrant further evaluation. Clinical correlation and dermoscopic examination recommended."
```

## Code Suggestions

All ICD-10 and CPT suggestions include:

```
üìã SUGGESTED CODES - VERIFY BEFORE SUBMISSION:
These are AI-generated suggestions based on documentation.
Provider must verify accuracy and appropriate documentation support.

ICD-10: L57.0 - Actinic keratosis [VERIFY BEFORE SUBMISSION]
CPT: 17000 - Destruction of lesion [VERIFY DOCUMENTATION SUPPORTS]
```

## Compliance Features

1. **No Definitive Diagnoses**: All assessments framed as "consistent with" or "differential includes"
2. **Treatment Caveats**: All treatment suggestions marked as provider-to-verify
3. **Fabrication Prevention**: Detects and flags information not provided in input
4. **Incomplete Documentation**: Marks sections needing provider completion
5. **Code Verification**: Requires explicit provider verification before billing submission

## Error Handling

The system will **throw errors** and **refuse to generate** if:
- Input is too brief (< 10 characters)
- No chief complaint provided
- Critical safety validation fails
- Output contains fabricated details

The system will **log warnings** for:
- Vague input language
- Missing hedging language
- Medication dosages without explicit input
- Overly specific codes without sufficient documentation

## Testing the Guardrails

To test that guardrails are working:

1. **Test Input Validation**:
   ```typescript
   // Should fail
   generateClinicalNote({ quickInput: "rash", chiefComplaint: "" })
   ```

2. **Test Output Sanitization**:
   - Check that generated notes use "consistent with" not "patient has"
   - Verify AI disclaimer appears at top
   - Confirm code suggestions have [VERIFY] markers

3. **Test Lesion Analysis**:
   ```typescript
   expandLesionDescription("dark mole", "back")
   // Should NOT contain diagnostic terms like "melanoma" or "malignant"
   // Should include disclaimer about clinical correlation
   ```

## Legal & Compliance Notes

‚ö†Ô∏è **Important**:
- AI suggestions are **not** medical diagnoses
- All AI output requires provider review and approval
- Provider has final responsibility for all documentation and coding
- These guardrails reduce risk but do not eliminate need for provider oversight
- Documentation must support medical necessity for billing

## Maintenance

When updating AI prompts or functions:
1. Always use guardrails validation
2. Test with edge cases (brief input, diagnostic language, etc.)
3. Verify disclaimers appear in output
4. Check that markers ([PROVIDER TO VERIFY], etc.) are present
5. Review logs for validation warnings

## Future Enhancements

Potential improvements:
- Severity scoring for validation warnings
- Integration with EHR audit logs
- Provider feedback loop for false positives
- Custom guardrail rules per practice
- Real-time validation UI indicators
